{% extends "base.html" %}

{% block title %}View Student Video - TKD AI{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 4px;
        overflow: hidden;
        max-height: 600px;
    }
    .video-container video {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
    }
    .comment-marker {
        position: absolute;
        bottom: 10px;
        width: 12px;
        height: 12px;
        background-color: #dc3545;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
        z-index: 10;
        transition: transform 0.2s;
    }
    .comment-marker:hover {
        transform: scale(1.2);
    }
    .comment-tooltip {
        position: absolute;
        bottom: 25px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        max-width: 200px;
        z-index: 20;
        display: none;
    }
    .comment-section {
        max-height: 400px;
        overflow-y: auto;
    }
    .comment-item {
        border-left: 3px solid #007bff;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    .comment-timestamp {
        color: #6c757d;
        font-size: 0.9em;
        font-weight: bold;
    }
    .comment-text {
        margin-top: 5px;
    }
    .comment-actions {
        margin-top: 5px;
    }
    .progress-bar-container {
        position: relative;
        height: 20px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin-top: 10px;
    }
    .progress-bar {
        height: 100%;
        background-color: #007bff;
        border-radius: 4px;
        transition: width 0.1s;
    }
    .comment-dots {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }
    .comment-dot {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background-color: #dc3545;
        border-radius: 50%;
        border: 1px solid white;
        pointer-events: auto;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_users') }}">Students</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_user_detail', user_id=user.id) }}">{{ user.username }}</a></li>
                    <li class="breadcrumb-item active">Video: {{ video.title }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Viewing Video: {{ video.title }}</h1>
                <div>
                    <span class="badge bg-primary">{{ user.username }}</span>
                    <span class="badge bg-secondary">{{ video.form_type or 'Unknown Form' }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Video Player Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Video Player</h5>
                </div>
                <div class="card-body">
                    <div class="video-container">
                        <video id="videoPlayer" controls>
                            <source src="{{ video.file_path }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    
                    <!-- Progress Bar with Comment Dots -->
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                        <div class="comment-dots" id="commentDots"></div>
                    </div>
                    
                    <!-- Comment Interface -->
                    <div class="mt-3">
                        <div class="d-flex gap-2">
                            <button id="addCommentBtn" class="btn btn-primary">
                                <i class="fas fa-comment me-2"></i>Add Comment at Current Time
                            </button>
                            <span id="currentTime" class="align-self-center">00:00</span>
                        </div>
                        
                        <div id="commentForm" class="mt-3" style="display: none;">
                            <div class="mb-3">
                                <label for="commentText" class="form-label">Comment:</label>
                                <textarea class="form-control" id="commentText" rows="3" placeholder="Enter your comment..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="saveCommentBtn" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Save Comment
                                </button>
                                <button id="cancelCommentBtn" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Comments ({{ comments|length }})</h5>
                </div>
                <div class="card-body">
                    <div class="comment-section" id="commentsList">
                        {% if comments %}
                            {% for comment in comments %}
                            <div class="comment-item" data-comment-id="{{ comment.id }}" data-timestamp="{{ comment.timestamp }}">
                                <div class="comment-timestamp">
                                    {{ "%.1f"|format(comment.timestamp) }}s - {{ comment.admin.username }}
                                </div>
                                <div class="comment-text">{{ comment.comment }}</div>
                                <div class="comment-actions">
                                    <button class="btn btn-sm btn-outline-primary goto-time-btn" data-timestamp="{{ comment.timestamp }}">
                                        <i class="fas fa-play me-1"></i>Go to Time
                                    </button>
                                    {% if comment.admin_id == current_user.id %}
                                    <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="{{ comment.id }}">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No comments yet. Add comments by pausing the video and clicking "Add Comment".</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let videoPlayer;
let comments = [];
let currentCommentTimestamp = 0;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    videoPlayer = document.getElementById('videoPlayer');
    
    // Load existing comments
    loadComments();
    
    // Set up event listeners
    setupEventListeners();
    
    // Update progress bar and time display
    videoPlayer.addEventListener('timeupdate', updateProgress);
    
    // Update current time display
    videoPlayer.addEventListener('timeupdate', function() {
        const currentTime = videoPlayer.currentTime;
        document.getElementById('currentTime').textContent = formatTime(currentTime);
    });
});

function setupEventListeners() {
    // Add comment button
    document.getElementById('addCommentBtn').addEventListener('click', function() {
        currentCommentTimestamp = videoPlayer.currentTime;
        document.getElementById('commentForm').style.display = 'block';
        document.getElementById('commentText').focus();
    });
    
    // Save comment button
    document.getElementById('saveCommentBtn').addEventListener('click', saveComment);
    
    // Cancel comment button
    document.getElementById('cancelCommentBtn').addEventListener('click', function() {
        document.getElementById('commentForm').style.display = 'none';
        document.getElementById('commentText').value = '';
    });
    
    // Go to time buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('goto-time-btn')) {
            const timestamp = parseFloat(e.target.dataset.timestamp);
            videoPlayer.currentTime = timestamp;
        }
        
        if (e.target.classList.contains('delete-comment-btn')) {
            const commentId = parseInt(e.target.dataset.commentId);
            deleteComment(commentId);
        }
    });
}

function loadComments() {
    fetch(`/api/video/{{ video.id }}/comments`)
        .then(response => response.json())
        .then(data => {
            comments = data;
            updateCommentDots();
            updateCommentsList();
        })
        .catch(error => console.error('Error loading comments:', error));
}

function saveComment() {
    const commentText = document.getElementById('commentText').value.trim();
    if (!commentText) {
        alert('Please enter a comment');
        return;
    }
    
    fetch(`/api/video/{{ video.id }}/comments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            timestamp: currentCommentTimestamp,
            comment: commentText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            comments.push(data);
            updateCommentDots();
            updateCommentsList();
            document.getElementById('commentForm').style.display = 'none';
            document.getElementById('commentText').value = '';
        }
    })
    .catch(error => {
        console.error('Error saving comment:', error);
        alert('Error saving comment');
    });
}

function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    fetch(`/api/comment/${commentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            comments = comments.filter(c => c.id !== commentId);
            updateCommentDots();
            updateCommentsList();
        } else {
            alert('Error deleting comment');
        }
    })
    .catch(error => {
        console.error('Error deleting comment:', error);
        alert('Error deleting comment');
    });
}

function updateCommentDots() {
    const container = document.getElementById('commentDots');
    container.innerHTML = '';
    
    comments.forEach(comment => {
        const dot = document.createElement('div');
        dot.className = 'comment-dot';
        dot.style.left = `${(comment.timestamp / videoPlayer.duration) * 100}%`;
        dot.title = `${comment.admin_name}: ${comment.comment.substring(0, 50)}...`;
        
        dot.addEventListener('click', function() {
            videoPlayer.currentTime = comment.timestamp;
        });
        
        container.appendChild(dot);
    });
}

function updateCommentsList() {
    const container = document.getElementById('commentsList');
    
    if (comments.length === 0) {
        container.innerHTML = '<p class="text-muted">No comments yet. Add comments by pausing the video and clicking "Add Comment".</p>';
        return;
    }
    
    container.innerHTML = comments.map(comment => `
        <div class="comment-item" data-comment-id="${comment.id}" data-timestamp="${comment.timestamp}">
            <div class="comment-timestamp">
                ${comment.timestamp.toFixed(1)}s - ${comment.admin_name}
            </div>
            <div class="comment-text">${comment.comment}</div>
            <div class="comment-actions">
                <button class="btn btn-sm btn-outline-primary goto-time-btn" data-timestamp="${comment.timestamp}">
                    <i class="fas fa-play me-1"></i>Go to Time
                </button>
                ${comment.admin_name === '{{ current_user.username }}' ? 
                    `<button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="${comment.id}">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>` : ''
                }
            </div>
        </div>
    `).join('');
}

function updateProgress() {
    const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Update comment dots when video metadata is loaded
videoPlayer.addEventListener('loadedmetadata', function() {
    updateCommentDots();
});
</script>
{% endblock %} 